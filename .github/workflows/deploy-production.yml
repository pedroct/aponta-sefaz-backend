# Deploy para Producao quando ha merge na branch main
# Documentacao: docs/DEPLOY.md
name: Deploy Production

on:
  push:
    branches:
      - main

env:
  DEPLOY_PATH: /home/ubuntu/aponta-sefaz/production/backend
  ENVIRONMENT: production

jobs:
  test:
    name: Testes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar dependencias
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Rodar testes
        run: pytest tests/ -v
        env:
          AUTH_ENABLED: "false"
          DATABASE_SCHEMA: api_aponta_test

  deploy:
    name: Deploy Production
    needs: test
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Configurar SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "::error::Chave privada nao foi importada corretamente"
            exit 1
          fi

          timeout 15 ssh-keyscan -t rsa -p 22 "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts 2>&1 || {
            ssh-keyscan -t rsa,ecdsa "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts 2>&1
          }

          timeout 10 ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo SSH OK" || {
            echo "::error::Erro ao conectar via SSH"
            exit 1
          }

      - name: Gerar .env a partir dos GitHub Secrets
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cat > /home/ubuntu/aponta-sefaz/production/.env << 'ENVEOF'
          # ==========================================
          # PRODUCTION - Auto-generated by GitHub Actions
          # Commit: ${{ github.sha }}
          # Branch: ${{ github.ref_name }}
          # Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          # ==========================================
          # NAO EDITE MANUALMENTE - Use GitHub Secrets
          # ==========================================

          # PostgreSQL
          DATABASE_NAME=gestao_projetos
          DATABASE_USER=aponta_user
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
          DATABASE_HOST=postgres-aponta
          DATABASE_PORT=5432
          DATABASE_SCHEMA=aponta_sefaz
          DATABASE_URL=postgresql://aponta_user:${{ secrets.DATABASE_PASSWORD }}@postgres-aponta:5432/gestao_projetos

          # API
          API_HOST=0.0.0.0
          API_PORT=8000
          API_DEBUG=false
          API_TITLE=API Aponta Sefaz
          API_VERSION=1.0.0
          ENVIRONMENT=production

          # Autenticacao Azure DevOps
          AUTH_ENABLED=true
          AZURE_DEVOPS_ORG_URL=https://dev.azure.com/sefaz-ceara
          AZURE_DEVOPS_PAT=${{ secrets.AZURE_DEVOPS_PAT }}
          AZURE_EXTENSION_SECRET=${{ secrets.AZURE_EXTENSION_SECRET }}

          # CORS
          CORS_ORIGINS=https://aponta.treit.com.br,https://dev.azure.com,https://*.visualstudio.com,https://*.vsassets.io

          # Seed
          SEED_INITIAL_DATA=false
          ENVEOF"

      - name: Sincronizar codigo para VPS
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='venv' \
            --exclude='.venv*' \
            --exclude='tests' \
            --exclude='.github' \
            --exclude='docs' \
            --exclude='.contexto' \
            --exclude='.context' \
            --exclude='htmlcov' \
            --exclude='*.code-workspace' \
            --exclude='.coverage*' \
            --exclude='coverage.xml' \
            --exclude='test-report.json' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.DEPLOY_PATH_PRD }}/

      - name: Build e Deploy do container
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            cd /home/ubuntu/aponta-sefaz/production && \
            docker rm -f api-aponta-prod || true && \
            docker compose build api && \
            docker tag production-api:latest production-api:${{ github.sha }} && \
            docker compose up -d --force-recreate --no-deps api
          "

      - name: Verificar deploy
        run: |
          echo "Aguardando inicializacao da API (25s)..."
          sleep 25

          if ! ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "docker exec api-aponta-prod curl -sf http://localhost:8000/health"; then
            echo "::error::Health check falhou! Obtendo logs do container..."
            ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "docker logs api-aponta-prod --tail 100"
            exit 1
          fi

          echo "Deploy producao verificado com sucesso!"
          echo "URL: https://aponta.treit.com.br"

      - name: Limpar imagens antigas (manter ultimas 5)
        if: success()
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            docker images production-api --format '{{.Tag}}' | \
            grep -E '^[a-f0-9]{40}$' | \
            tail -n +6 | \
            xargs -I {} docker rmi production-api:{} 2>/dev/null || true
          "
